<!DOCTYPE html>
<html>
<head>
    <title>Passkey Login</title>
</head>
<body>
<h2>Login with Passkey</h2>
<input type="text" id="username" placeholder="Enter username">
<button onclick="loginWithPasskey()">Login with Passkey</button>
<div id="result"></div>

<script>
    function base64urlToArrayBuffer(base64url) {
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function arrayBufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    async function loginWithPasskey() {
        const username = document.getElementById('username').value;

        try {
            const response = await fetch('/passkey/login/authenticate/start?username=' + username, {
                method: 'POST'
            });
            const options = await response.json();

            options.challenge = base64urlToArrayBuffer(options.challenge);
            
            // Remove problematic extensions
            delete options.extensions;

            const credential = await navigator.credentials.get({publicKey: options});

            const credentialForServer = {
                id: credential.id,
                rawId: arrayBufferToBase64url(credential.rawId),
                response: {
                    authenticatorData: arrayBufferToBase64url(credential.response.authenticatorData),
                    clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
                    signature: arrayBufferToBase64url(credential.response.signature)
                },
                clientExtensionResults: {},
                type: credential.type
            };

            const loginResponse = await fetch('/passkey/login/authenticate/finish?username=' + username, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(credentialForServer)
            });

            if (loginResponse.ok) {
                window.location.href = '/';  // Redirect to dashboard
            } else {
                document.getElementById('result').innerHTML = 'Login failed!';
            }
        } catch (error) {
            document.getElementById('result').innerHTML = 'Error: ' + error.message;
        }
    }
</script>
</body>
</html>
