<!DOCTYPE html>
<html>
<head>
    <title>Register Passkey</title>
</head>
<body>
<h2>Register Your Passkey</h2>
<input type="text" id="username" placeholder="Enter username">
<button onclick="registerPasskey()">Register Passkey</button>
<div id="result"></div>

<script>
    function base64urlToArrayBuffer(base64url) {
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function arrayBufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    async function registerPasskey() {
        const username = document.getElementById('username').value;

        try {
            const response = await fetch('/passkey/register/start?username=' + username, {
                method: 'POST'
            });
            const options = await response.json();

            // Convert base64url strings to ArrayBuffers
            options.challenge = base64urlToArrayBuffer(options.challenge);
            options.user.id = base64urlToArrayBuffer(options.user.id);
            
            // Remove problematic extensions
            delete options.extensions;

            const credential = await navigator.credentials.create({publicKey: options});

            // Convert ArrayBuffers back to base64url for sending to server
            const credentialForServer = {
                id: credential.id,
                rawId: arrayBufferToBase64url(credential.rawId),
                response: {
                    attestationObject: arrayBufferToBase64url(credential.response.attestationObject),
                    clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON)
                },
                clientExtensionResults: {},
                type: credential.type
            };

            await fetch('/passkey/register/finish?username=' + username, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(credentialForServer)
            });

            document.getElementById('result').innerHTML = 'Passkey registered successfully!';
        } catch (error) {
            document.getElementById('result').innerHTML = 'Error: ' + error.message;
        }
    }
</script>
</body>
</html>
